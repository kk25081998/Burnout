{% extends "base.html" %}

{% block content %}
<div class="container">

    <!-- Chart.js Line Chart -->
    <div>
        <canvas id="lineChart"></canvas>
    </div>

    {% for result in results %}
    <div class="card" style="margin-bottom: 1em;">
        <div class="card-body">
            <h5 class="card-title">Test Date: {{ result.testDate }}</h5>
            <p class="card-text">
                Burnout Level: 
                {% if result.scoreA <= 17 %}
                    Low
                {% elif result.scoreA > 17 and result.scoreA <= 29 %}
                    Moderate
                {% else %}
                    High
                {% endif %}
                <br>
                Depersonalization Level:
                {% if result.scoreB <= 5 %}
                    Low
                {% elif result.scoreB > 5 and result.scoreB <= 11 %}
                    Moderate
                {% else %}
                    High
                {% endif %}
                <br>
                Personal Achievement Level:
                {% if result.scoreC <= 33 %}
                    High 
                {% elif result.scoreC > 33 and result.scoreC <= 39 %}
                    Moderate 
                {% else %}
                    Low 
                {% endif %}
            </p>
            <p class="card-text">
                Overall Burnout Risk: 
                {% set highCount = (1 if result.scoreA > 30 else 0) + (1 if result.scoreB >= 12 else 0) + (1 if result.scoreC <= 33 else 0) %}
                {% set moderateCount = (1 if result.scoreA > 17 and result.scoreA <= 30 else 0) + (1 if result.scoreB > 5 and result.scoreB <= 11 else 0) + (1 if result.scoreC > 33 and result.scoreC <= 39 else 0) %}
                {% if highCount >= 2 %}
                    High
                {% elif highCount == 1 and moderateCount >= 1 %}
                    Moderate
                {% else %}
                    Low
                {% endif %}
            </p>                      
        </div>
    </div>
    {% endfor %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    var ctx = document.getElementById('lineChart').getContext('2d');
    
    function getGradientColor(value) {
        var gradient = ctx.createLinearGradient(0, 0, 0, 400);
    
        if (value <= 33) {
            gradient.addColorStop(0, 'lightgreen');
            gradient.addColorStop(1, 'green');
        } else if (value <= 66) {
            gradient.addColorStop(0, 'yellow');
            gradient.addColorStop(1, 'orange');
        } else {
            gradient.addColorStop(0, 'salmon');
            gradient.addColorStop(1, 'red');
        }
    
        return gradient;
    }
    
    // Get the last 12 results
    var last12Results = [
        {% for result in results[:12] %}
            {
                'testDate': '{{ result.testDate.strftime('%b %y') }}',
                'scoreA': {{ result.scoreA }},
                'scoreB': {{ result.scoreB }},
                'scoreC': {{ result.scoreC }}
            },
        {% endfor %}
    ];

    var dataValues = [];
    var backgroundColors = [];
    last12Results.forEach(function(result) {
        var invertedScoreC = 48 - result.scoreC;
        var totalScore = result.scoreA + result.scoreB + invertedScoreC;
        var scaledScore = Math.round((totalScore / 132) * 100);
        dataValues.push(scaledScore);
        backgroundColors.push(getGradientColor(scaledScore));
    });

    var barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: last12Results.map(function(result) { return result.testDate; }),
            datasets: [{
                label: 'Burnout Level',
                data: dataValues,
                backgroundColor: backgroundColors,
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'x',
            scales: {
                x: {
                    stacked: false,
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        min: 0,
                        max: 100,
                        stepSize: 33,
                        callback: function(value, index, values) {
                            if (value === 0) return 'No Burnout';
                            if (value === 33) return 'Low Burnout ';
                            if (value === 66) return 'Moderate Burnout ';
                            if (value === 100) return 'High Burnout';
                            return '';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            layout: {
                padding: {
                    left: 20,
                    right: 20,
                    top: 50,
                    bottom: 50
                }
            },
            barThickness: 20 // Adjust the bar thickness here
        }
    });
    </script>

</div>
{% endblock %}